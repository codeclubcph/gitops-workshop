apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # 1. Define the Trigger: When should we alert?
  trigger.on-degraded: |
    - description: Application is degraded
      send: [send-to-log] # Reference the template below
      when: app.status.health.status == 'Degraded'

  # 2. Define the Template: What should the alert say?
  template.send-to-log: |
    message: |
      ðŸš¨ Alert: Application {{.app.metadata.name}} is {{.app.status.health.status}}!
      Reason: {{.app.status.operationState.message}}
      View here: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  # 3. Define the Service (Destination)
  # For this workshop, we output to the controller logs to keep it simple
  service.webhook.log-sink: |
    url: http://postman-echo.com/post
    method: POST